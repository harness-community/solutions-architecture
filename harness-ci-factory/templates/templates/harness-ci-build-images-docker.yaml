# Gather and Collate available and in-use Harness CI Image details
spec:
  type: CI
  spec:
    cloneCodebase: false
    infrastructure:
      type: KubernetesDirect
      spec:
        connectorRef: ${KUBERNETES_CONNECTOR_REF}
        namespace: ${KUBERNETES_NAMESPACE}
        automountServiceAccountToken: true
        nodeSelector: {}
        os: Linux
    execution:
      steps:
        - step:
            identifier: Generate_Dockerfile
            name: Generate Dockerfile
            description: This step will create a new Dockerfile to be leveraged in the upcoming Build and Push step.  In addition this step leverages the RUNNER_IMAGE retrieved from the 'Gather Harness Images' stage.
            type: Run
            spec:
              connectorRef: ${HARNESS_IMAGE_CONNECTOR}
              image: <+stage.variables.RUN_STEP_RUNNER>
              shell: Sh
              command: |
                set -eo pipefail
                set +x
                echo "Generating Dockerfile for $IMAGE"
                echo "--------------"
                mkdir -p $IMAGE_NAME
                cat <<EOF >$IMAGE_NAME/Dockerfile
                FROM $IMAGE
                EOF
                echo
                echo "Display Generated Dockerfile"
                echo "--------------"
                cat $IMAGE_NAME/Dockerfile
              envVariables:
                IMAGE: <+stage.variables.IMAGE>
                IMAGE_NAME: <+stage.variables.IMAGE_NAME>
        - step:
            type: BuildAndPushDockerRegistry
            identifier: BuildandPushtoDocker
            name: Build and Push to Docker
            spec:
              connectorRef: ${CONTAINER_REGISTRY_CONNECTOR}
              repository: <+stage.variables.REGISTRY>/<+stage.variables.IMAGE_NAME>
              tags:
                - <+stage.variables.IMAGE_VERSION>
              dockerfile: <+stage.variables.IMAGE_NAME>/Dockerfile
            failureStrategies: []
            when:
              stageStatus: Success
  tags: {}
  variables:
    - name: REGISTRY
      type: String
      description: Container registry name to which the image will be uploaded - e.g. registry.company.com
      value: <+input>
    - name: IMAGE
      type: String
      description: Full repository path and tag for the image - e.g. harness/ci-addon:1.16.0
      value: <+input>
    - name: IMAGE_NAME
      type: String
      description: Name of the image to create - e.g. harness/ci-addon
      value: <+input>
    - name: IMAGE_VERSION
      type: String
      description: Version Tag of the image to create - e.g. 1.16.0
      value: <+input>
    - name: RUN_STEP_RUNNER
      type: String
      description: Container Image to be used for the run_step to generate a new Dockerfile
      value: <+input>

